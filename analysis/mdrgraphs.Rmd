---
title: "MDR graphs"
author: "MDR Intertidal"
output: github_document
---

```{r load-packages, message = FALSE}
library(tidyverse)
library(broom)
library(readxl)
library(scales)
library(lubridate)
library(ggplot2)
library(waffle)
library(dplyr)

se <- function(x) sd(x)/sqrt(length(x))
```

```{r load-data}
expanded_inverts_mdr <- read_csv("/cloud/project/analysis/expanded_inverts_mdr.csv")
expanded_seaweeds_mdr <- read_csv("/cloud/project/analysis/expanded_seaweeds_mdr.csv")
mdr_temp_allyears <- read_csv("/cloud/project/analysis/mdr_temp_allyears.csv")
all_tide_time <- read_csv("/cloud/project/analysis/all_tide_time.csv")
```

```{r total-snails-per-quadrat-unfaceted}

# total number per quadrat, unfaceted

expanded_inverts_mdr %>%
  filter(invert_species %in% c("Litt_l",
                               "Litt_o",
                               "Litt_s"),
         !(year == 2017)) %>%
  ggplot(mapping = aes(year, count, fill = invert_species)) +
    geom_col(position = "dodge") +
  labs(fill = "snail species") +
  scale_fill_viridis_d(
    labels = c("Litt_l" = "Littorina littorea",
               "Litt_o" = "Littorina obtusata",
               "Litt_s" = "Littorina saxatilis")
  )

```

```{r total-snails-per-quadrat-faceted}

expanded_inverts_mdr %>%
  filter(invert_species %in% c("Litt_l",
                               "Litt_o",
                               "Litt_s"),
         !(year == 2017),
         !is.na(tide_ht)) %>%
  mutate(tide_ht = fct_relevel(tide_ht, c("H", "M", "L"))) %>%
  ggplot(mapping = aes(year, count, fill = invert_species)) +
    geom_col(position = "dodge") +
  labs(fill = "snail species") +
  scale_fill_viridis_d(
    labels = c("Litt_l" = "Littorina littorea",
               "Litt_o" = "Littorina obtusata",
               "Litt_s" = "Littorina saxatilis")
  ) +
  facet_wrap("tide_ht", nrow = 1)

# omitted 2017 and 2018 for all snail graphs (2017 includes L_spp, so not useful for these graphs, and 2018 is too messy)

```

```{r mean-snails-per-quadrat-unfaceted}

expanded_inverts_mdr %>%
  filter(invert_species %in% c("Litt_l",
                               "Litt_o",
                               "Litt_s"),
         !(year == 2017),
         !is.na(tide_ht)) %>%
  group_by(year, invert_species) %>%
  summarise(mean_count = mean(count), sd = sd(count), n = n()) %>%
  mutate(se = sd/sqrt(n)) %>%
  ggplot(mapping = aes(year, mean_count, fill = invert_species)) +
    geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = mean_count - se, ymax = mean_count + se),
                width=.5, position = position_dodge(.9)) +
  labs(fill = "snail species") +
  scale_fill_viridis_d(
    labels = c("Litt_l" = "Littorina littorea",
               "Litt_o" = "Littorina obtusata",
               "Litt_s" = "Littorina saxatilis")
  )

# are the error bars doing what they're supposed to now?

```

```{r mean-snails-per-quadrat-faceted}

expanded_inverts_mdr %>%
  filter(invert_species %in% c("Litt_l",
                               "Litt_o",
                               "Litt_s"),
         !(year == 2017),
         !is.na(tide_ht)) %>%
  mutate(tide_ht = fct_relevel(tide_ht, c("H", "M", "L"))) %>%
  group_by(year, tide_ht, invert_species) %>%
  summarise(mean_count = mean(count), sd = sd(count), n = n()) %>%
  mutate(se = sd/sqrt(n)) %>%
  ggplot(mapping = aes(year, mean_count, fill = invert_species)) +
    geom_col(position = "dodge") +
  geom_errorbar(aes(ymin = mean_count - se, ymax = mean_count + se),
                width=.3, position = position_dodge(.9)) +
  labs(fill = "snail species") +
  scale_fill_viridis_d(
    labels = c("Litt_l" = "Littorina littorea",
               "Litt_o" = "Littorina obtusata",
               "Litt_s" = "Littorina saxatilis")
    ) +
  facet_wrap("tide_ht", nrow = 1)

# better to have all in same column or all in same row? if in same row, how to make them shorter?
# are these error bars right? they're better...

```

```{r mean-snails-per-quadrat-faceted-plus-Lacu_v-Nuce_l, fig.height=4, fig.width=9}

# use this one for presentation
# how many years has L. vincta been on the survey? would they have counted it? ask Tanya

expanded_inverts_mdr %>%
  filter(invert_species %in% c("Litt_l",
                               "Litt_o",
                               "Litt_s",
                               "Lacu_v",
                               "Nuce_l"),
         !(year == 2017),
         !is.na(tide_ht)) %>%
  mutate(count = replace_na(count, 0)) %>%
  mutate(tide_ht_2 = case_when(tide_ht == "H" ~ "High Tide",
                               tide_ht == "M" ~ "Mid Tide",
                               tide_ht == "L" ~ "Low Tide")) %>%
  group_by(year, tide_ht_2, invert_species) %>%
  summarise(mean_count = mean(count), se_count = se(count)) %>%
  mutate(tide_ht_2 = fct_relevel(tide_ht_2, c("High Tide",
                                              "Mid Tide",
                                              "Low Tide"))) %>%
  ggplot(mapping = aes(year, mean_count, fill = invert_species)) +
    geom_col(position = "dodge", width = 0.7, color = "black", size = .3) +
  labs(fill = "snail species") +
  geom_errorbar(aes(ymin = mean_count - se_count, ymax = mean_count + se_count),
                width=.35, position = position_dodge(0.7)) +
  scale_fill_manual(values = c("#ffffcc", "#a1dab4", "#41b6c4", "#2c7fb8", "#253494"),
                    labels = c("Litt_l" = "Littorina littorea",
                               "Litt_o" = "Littorina obtusata",
                               "Litt_s" = "Littorina saxatilis",
                               "Lacu_v" = "Lacuna vincta",
                               "Nuce_l" = "Nucella lapillus")) +
  facet_wrap("tide_ht_2", nrow = 1) +
  labs(x = "Year",
       y = "Mean Number of Snails Per Quadrat",
       title  = "Snail Abundance in the Mount Desert Rock Intertidal",
       subtitle = "by Year, Tide Height, and Species",
       fill = "Snail Species") +
  theme(legend.text = element_text(face="italic")) +
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 8, b = 0, l = 0))) +
  theme(axis.title.x = element_text(margin = margin(t = 8, r = 0, b = 0, l = 0)))

# ggsave("snail_graph.png")

```

```{r L-mean-seaweed-cover-graph}
expanded_seaweeds_mdr <- expanded_seaweeds_mdr %>%
  mutate(seaweed_simple = gsub("CC", "", seaweed_species)) %>%
  mutate(seaweed_simple = gsub("SC", "", seaweed_simple))
  # mutate(seaweed_simple = gsub("Fucu_d", "Fucu_spp", seaweed_simple)) %>%
  # mutate(seaweed_simple = gsub("Fucu_s", "Fucu_spp", seaweed_simple)) %>%
  # mutate(seaweed_simple = gsub("Fucu_v", "Fucu_spp", seaweed_simple))

expanded_seaweeds_mdr %>%
  filter(seaweed_simple %in% c("Fucu_spp",
                               "Fucu_d",
                               "Fucu_s",
                               "Fucu_v",
                               "Ulva_l",
                               # "Cera_r",
                               "Mast_s",
                               "Cora_o",
                               "Chon_c"),
         tide_ht == "L") %>%
  group_by(year, tide_ht, seaweed_simple) %>%
  summarise(mean_proportion = mean(proportion), sd = sd(proportion), n = n()) %>%
  mutate(se = sd/sqrt(n)) %>%
  mutate(ymin_seaweeds = mean_proportion - se) %>%
  mutate(ymin_seaweeds = case_when(ymin_seaweeds < 0 ~ 0,
                          TRUE ~ ymin_seaweeds)) %>%
  mutate(ymax_seaweeds = mean_proportion + se) %>%
  ggplot(mapping = aes(year, mean_proportion, fill = seaweed_simple)) +
    geom_col(position = "dodge") +
    labs(fill = "seaweed species") +
    scale_fill_viridis_d(labels = c("Chon_c" = "Chondrus crispus",
                                    "Cora_o" = "Corallina officinalis",
                                    "Fucu_d" = "Fucus distichus",
                                    "Fucu_s" = "Fucus spiralis",
                                    "Fucu_spp" = "Fucus spp.",
                                    "Fucu_v" = "Fucus vesiculosis",
                                    "Mast_s" = "Mastrocarpus stellatus",
                                    "Ulva_l" = "Ulva lactuca"
    )
    ) +
    scale_x_continuous(breaks = breaks_width(1)) +
    geom_errorbar(aes(ymin = ymin_seaweeds, ymax = ymax_seaweeds), width=.3, position = position_dodge(.9))

# sum ALL Fucus in each plot before calculating mean (I think I did this but not sure)
# why so little Fucus? I know it was there
# a thought: where do the snails go at high tide? does it make sense to focus only on low if they go higher when tide is high?
```

```{r L-mean-seaweed-cover-graph-faceted}
expanded_seaweeds_mdr <- expanded_seaweeds_mdr %>%
  mutate(seaweed_simple = gsub("CC", "", seaweed_species)) %>%
  mutate(seaweed_simple = gsub("SC", "", seaweed_simple))
  # mutate(seaweed_simple = gsub("Fucu_d", "Fucu_spp", seaweed_simple)) %>%
  # mutate(seaweed_simple = gsub("Fucu_s", "Fucu_spp", seaweed_simple)) %>%
  # mutate(seaweed_simple = gsub("Fucu_v", "Fucu_spp", seaweed_simple))

seaweed_labs <- c("Ceramium rubrum",
                  "Chondrus crispus",
                  "Corallina officinalis",
                  "Fucus distichus",
                  "Fucus spiralis",
                  "Fucus spp.",
                  "Fucus vesiculosis",
                  "Mastrocarpus stellatus",
                  "Ulva lactuca")
names(seaweed_labs) <- c("Cera_r",
                         "Chon_c",
                         "Cora_o",
                         "Fucu_d",
                         "Fucu_s",
                         "Fucu_spp",
                         "Fucu_v",
                         "Mast_s",
                         "Ulva_l")

expanded_seaweeds_mdr %>%
  filter(seaweed_simple %in% c("Cera_r",
                               "Chon_c",
                               "Cora_o",
                               "Fucu_d",
                               "Fucu_s",
                               "Fucu_spp",
                               "Fucu_v",
                               "Mast_s",
                               "Ulva_l"),
         tide_ht == "L") %>%
  group_by(year, tide_ht, seaweed_simple) %>%
  summarise(mean_proportion = mean(proportion), sd = sd(proportion), n = n()) %>%
  mutate(se = sd/sqrt(n)) %>%
  mutate(ymin_seaweeds = mean_proportion - se) %>%
  mutate(ymin_seaweeds = case_when(ymin_seaweeds < 0 ~ 0,
                          TRUE ~ ymin_seaweeds)) %>%
  mutate(ymax_seaweeds = mean_proportion + se) %>%
  ggplot(mapping = aes(year, mean_proportion, fill = seaweed_simple)) +
    geom_col(position = "dodge") +
    labs(fill = "seaweed species", y = "mean proportion") +
    scale_fill_viridis_d(labels = c("Cera_r" = "Ceramium rubrum",
                                    "Chon_c" = "Chondrus crispus",
                                    "Cora_o" = "Corallina officinalis",
                                    "Fucu_d" = "Fucus distichus",
                                    "Fucu_s" = "Fucus spiralis",
                                    "Fucu_spp" = "Fucus spp.",
                                    "Fucu_v" = "Fucus vesiculosis",
                                    "Mast_s" = "Mastrocarpus stellatus",
                                    "Ulva_l" = "Ulva lactuca")) +
    scale_x_continuous(breaks = breaks_width(1)) +
    geom_errorbar(aes(ymin = ymin_seaweeds, ymax = ymax_seaweeds), width=.3, position = position_dodge(.9)) +
    coord_cartesian(ylim = c(0, NA)) +
  facet_wrap(. ~seaweed_simple, labeller = labeller(seaweed_simple = seaweed_labs))

# sum ALL Fucus in each plot before calculating mean (I think I did this but not sure)
# why so little Fucus? I know it was there
# a thought: where do the snails go at high tide? does it make sense to focus only on low if they go higher when tide is high?
```
```{r L-total-seaweed-cover-graph}
expanded_seaweeds_mdr %>%
  filter(seaweed_simple %in% c("Fucu_spp",
                               "Fucu_d",
                               "Fucu_s",
                               "Fucu_v",
                               "Ulva_l",
                               "Mast_s",
                               "Cora_o",
                               "Chon_c"),
         tide_ht == "L") %>%
  group_by(year, tide_ht, seaweed_simple) %>%
  ggplot(mapping = aes(year, proportion, fill = seaweed_simple)) +
    geom_col(position = "dodge") +
    labs(fill = "seaweed species") +
    scale_fill_viridis_d(labels = c("Cera_r" = "Ceramium rubrum",
                                    "Chon_c" = "Chondrus crispus",
                                    "Cora_o" = "Corallina officinalis",
                                    "Fucu_d" = "Fucus distichus",
                                    "Fucu_s" = "Fucus spiralis",
                                    "Fucu_spp" = "Fucus spp.",
                                    "Fucu_v" = "Fucus vesiculosis",
                                    "Mast_s" = "Mastrocarpus stellatus",
                                    "Ulva_l" = "Ulva lactuca")) +
    scale_x_continuous(breaks = breaks_width(1)) +
    coord_cartesian(ylim = c(0, NA))

# sum ALL Fucus in each plot before calculating mean (see previous code chunk)
# what's up with the error bars??
```

```{r total-ulva_l-graph}

expanded_seaweeds_mdr %>%
  filter(seaweed_simple == "Ulva_l",
         !is.na(tide_ht)) %>%
  group_by(year, tide_ht, seaweed_simple) %>%
  ggplot(mapping = aes(year, proportion, fill = tide_ht)) +
    geom_col() +
    labs(fill = "tide height") +
    scale_fill_viridis_d(labels = c("H" = "High",
                                    "L" = "Low",
                                    "M" = "Mid")) +
    scale_x_continuous(breaks = breaks_width(1)) +
    coord_cartesian(ylim = c(0, NA))

# I don't believe there was that much Ulva in the high quadrats

```

```{r temperature-graph-all-days, fig.alt = "Scatterplot of Mount Desert Rock mid tide temperatures in degrees celcius, shown across a date range from 2017 to 2022. The temperatures range from negative 10 to 30 degrees celcius and fluctute throughout the year. Colder temperatures occur in the Winter and warmer temperatures occur in the summer months.}

mdr_temp_allyears %>%
  group_by(date) %>%
  summarise(mean_temp_C_date = mean(temp_C, na.rm = TRUE)) %>%
  ggplot(mapping = aes(date, mean_temp_C_date)) +
  geom_point() +
  labs(y = "mean temperature (C)") +
  geom_abline(slope = 0, intercept = 0, color = "blue") +
  scale_x_date(breaks = breaks_width("1 year"))

mdr_temp_allyears %>%
  ggplot(mapping = aes(date, temp_C)) +
  geom_point(alpha = .1) +
  # geom_smooth() +
  labs(title = "Mid tide temperature at Mount Desert Rock ",
       subtitle = "From 2017 to 2022",
       y = "temperature (C)") +
  geom_abline(slope = 0, intercept = 0, color = "blue") +
  scale_x_date(breaks = breaks_width("1 year"))

```

```{r temp-graphs-by-tide}
mdr_temp_alltides %>%
  ggplot(mapping = aes(x = date.x, y = temp_C, colour = tide_ht)) +
  geom_point(alpha = .1) +
  # geom_smooth() +
  labs(y = "temperature (C)") +
  geom_abline(slope = 0, intercept = 0, color = "blue") +
  scale_x_date(breaks = breaks_width("1 year"))

mdr_temp_high_tide %>%
  ggplot(mapping = aes(date.x, temp_C)) +
  geom_point() +
  labs(y = "temperature (C)") +
  geom_abline(slope = 0, intercept = 0, color = "blue") +
  scale_x_date(breaks = breaks_width("1 year"))

mdr_temp_low_tide %>%
  ggplot(mapping = aes(date.x, temp_C)) +
  geom_point() +
  labs(y = "temperature (C)") +
  geom_abline(slope = 0, intercept = 0, color = "blue") +
  scale_x_date(breaks = breaks_width("1 year"))
```


```{r waffle-animation}

test <- all_inverts_mdr %>%
  filter(year != 2017) %>%
  group_by(year, tide_ht, quadrat_number) %>%
  mutate(max_count = max(count)) %>%
  filter(count == max_count) %>%
  select(year, tide_ht, quadrat_number, invert_species, max_count) 

test_1 <- test %>%
  filter(max_count == 0) %>%
  mutate(invert_species_max = invert_species == NA)

test_2 <- test %>%
  filter(max_count != 0) %>%
  mutate(invert_species_max = invert_species)

invert_waffle <- rbind(test_1, test_2) %>%
  select(-invert_species) %>%
  distinct(invert_species_max, .keep_all = TRUE) %>%
  arrange(year, tide_ht)

#where's 2021

%>%
  filter(tide_ht == "H") %>%
  ggplot(aes(x = quadrat_number, 
             color = inverts_species_max))
  
```